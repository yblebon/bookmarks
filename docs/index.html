<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bookmark Collection – Searchable & Sortable</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background:#f9f9f9;
            margin:0;
            display:flex;
            justify-content:center;
            align-items:flex-start;
            padding:3rem 1rem;
        }
        .wrapper {
            max-width:800px;
            width:100%;
        }
        h1 {
            color:#2c3e50;
            text-align:center;
            margin-bottom:0.5rem;
        }
        #controls {
            display:flex;
            gap:0.5rem;
            margin-bottom:1.5rem;
        }
        #search, #sortBtn {
            padding:0.7rem;
            font-size:1rem;
            border:1px solid #ccc;
            border-radius:4px;
            box-sizing:border-box;
        }
        #search {flex:1;}
        #sortBtn {background:#2980b9; color:#fff; cursor:pointer;}
        .card {
            background:#fff;
            border:1px solid #ddd;
            border-radius:5px;
            padding:1rem;
            margin-bottom:1.5rem;
            box-shadow:0 2px 4px rgba(0,0,0,0.05);
        }
        .card a.title {
            text-decoration:none;
            color:#2980b9;
            font-weight:bold;
            font-size:1.2rem;
        }
        .preview {
            margin:0.8rem 0;
            max-width:100%;
            overflow:hidden;
        }
        .preview img,
        .preview iframe {
            max-width:100%;
            border:none;
        }
        .tags {margin-top:.5rem;}
        .tag {
            display:inline-block;
            background:#e0e0e0;
            color:#333;
            border-radius:3px;
            padding:2px 6px;
            margin-right:4px;
            font-size:.85rem;
        }
        .date {
            color:#777;
            font-size:.9rem;
            margin-top:.5rem;
        }
        .no-results {
            color:#c0392b;
            font-weight:bold;
            text-align:center;
            margin-top:2rem;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <h1>Bookmark Collection</h1>
        <div id="controls">
            <input type="text" id="search" placeholder="Search by title or tag…">
            <button id="sortBtn">Sort by Newest</button>
        </div>
        <div id="bookmarks"></div>
    </div>

    <script>
        const dataUrl = 'https://raw.githubusercontent.com/yblebon/datasources/main/bookmarks.json';
        let allBookmarks = [];          // raw objects
        let displayedBookmarks = [];    // objects with .element
        let sortDesc = true;            // newest first

        // ---------- Helpers ----------
        function createTag(text) {
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = text;
            return span;
        }
        function getYouTubeEmbed(url) {
            const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/))([^\s&]+)/);
            return m ? `https://www.youtube.com/embed/${m[1]}` : null;
        }
        async function fetchOpenGraphImage(pageUrl) {
            try {
                const r = await fetch(`https://r.jina.ai/http://${pageUrl}`);
                const d = await r.json();
                return d?.metadata?.og_image || null;
            } catch { return null; }
        }

        // ---------- Card rendering (cached) ----------
        const cardCache = new Map(); // url → element
        async function renderCard(item) {
            if (cardCache.has(item.url)) return cardCache.get(item.url);

            const card = document.createElement('div');
            card.className = 'card';

            const link = document.createElement('a');
            link.href = item.url;
            link.target = '_blank';
            link.className = 'title';
            link.textContent = item.title;
            card.appendChild(link);

            const preview = document.createElement('div');
            preview.className = 'preview';

            const yt = getYouTubeEmbed(item.url);
            if (yt) {
                const iframe = document.createElement('iframe');
                iframe.src = yt;
                iframe.width = '560';
                iframe.height = '315';
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.allowFullscreen = true;
                preview.appendChild(iframe);
            } else {
                const imgUrl = await fetchOpenGraphImage(item.url);
                if (imgUrl) {
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.alt = 'Preview image';
                    preview.appendChild(img);
                } else {
                    const p = document.createElement('p');
                    p.textContent = item.description;
                    preview.appendChild(p);
                }
            }
            card.appendChild(preview);

            const tagsDiv = document.createElement('div');
            tagsDiv.className = 'tags';
            item.tags.forEach(t => tagsDiv.appendChild(createTag(t)));
            card.appendChild(tagsDiv);

            const dateDiv = document.createElement('div');
            dateDiv.className = 'date';
            dateDiv.textContent = `Published: ${item.date}`;
            card.appendChild(dateDiv);

            cardCache.set(item.url, card);
            return card;
        }

        // ---------- Display ----------
        function display(list) {
            const container = document.getElementById('bookmarks');
            container.innerHTML = '';
            if (list.length === 0) {
                const msg = document.createElement('div');
                msg.className = 'no-results';
                msg.textContent = 'No bookmarks match your search.';
                container.appendChild(msg);
                return;
            }
            const fragment = document.createDocumentFragment();
            list.forEach(b => fragment.appendChild(b.element));
            container.appendChild(fragment);
        }

        // ---------- Search ----------
        function matches(item, q) {
            const lower = q.toLowerCase();
            return item.title.toLowerCase().includes(lower) ||
                   item.tags.some(t => t.toLowerCase().includes(lower));
        }

        // ---------- Sorting ----------
        function sortAndRefresh() {
            displayedBookmarks.sort((a, b) => {
                const da = new Date(a.date);
                const db = new Date(b.date);
                return sortDesc ? db - da : da - db;
            });
            display(displayedBookmarks);
        }

        // ---------- Init ----------
        async function init() {
            const raw = await fetch(dataUrl).then(r => r.ok ? r.json() : Promise.reject());
            // Build objects with rendered elements (async, but sequentially to avoid flooding)
            for (const item of raw) {
                const el = await renderCard(item);
                allBookmarks.push(item);
                displayedBookmarks.push({ ...item, element: el });
            }
            sortAndRefresh();
        }
        init().catch(err => {
            console.error(err);
            document.getElementById('bookmarks').textContent = 'Failed to load bookmarks.';
        });

        // ---------- Event listeners ----------
        document.getElementById('search').addEventListener('input', e => {
            const q = e.target.value.trim();
            if (!q) {
                displayedBookmarks = allBookmarks.map(i => ({
                    ...i,
                    element: cardCache.get(i.url)
                }));
                sortAndRefresh();
                return;
            }
            displayedBookmarks = allBookmarks
                .filter(i => matches(i, q))
                .map(i => ({ ...i, element: cardCache.get(i.url) }));
            sortAndRefresh();
        });

        document.getElementById('sortBtn').addEventListener('click', () => {
            sortDesc = !sortDesc;
            document.getElementById('sortBtn').textContent = sortDesc ? 'Sort by Newest' : 'Sort by Oldest';
            sortAndRefresh();
        });
    </script>
</body>
</html>
